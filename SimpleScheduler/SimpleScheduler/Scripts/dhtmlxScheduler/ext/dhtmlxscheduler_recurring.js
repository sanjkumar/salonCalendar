/*
Copyright Dinamenta, UAB. http://www.dhtmlx.com
To use this component please contact sales@dhtmlx.com to obtain license
*/
Scheduler.plugin(function(c){c.config.occurrence_timestamp_in_utc=!1;c.form_blocks.recurring={render:function(){return c.__recurring_template},_ds:{},_init_set_value:function(a,b,e){function f(a){for(var b=0;b<a.length;b++){var c=a[b];c.type=="checkbox"||c.type=="radio"?(i[c.name]||(i[c.name]=[]),i[c.name].push(c)):i[c.name]=c}}function g(a){for(var b=i[a],c=0;c<b.length;c++)if(b[c].checked)return b[c].value}function d(){n("dhx_repeat_day").style.display="none";n("dhx_repeat_week").style.display=
"none";n("dhx_repeat_month").style.display="none";n("dhx_repeat_year").style.display="none";n("dhx_repeat_"+this.value).style.display="block"}function h(a){var b=[g("repeat")];for(r[b[0]](b,a);b.length<5;)b.push("");var e="";if(i.end[0].checked)a.end=new Date(9999,1,1),e="no";else if(i.end[2].checked)a.end=k(i.date_of_end.value);else{c.transpose_type(b.join("_"));var e=Math.max(1,i.occurences_count.value),d=b[0]=="week"&&b[4]&&b[4].toString().indexOf(c.config.start_on_monday?1:0)==-1?1:0;a.end=c.date.add(new Date(a.start),
e+d,b.join("_"))}return b.join("_")+"#"+e}function j(a,b){var c=a.split("#"),a=c[0].split("_");s[a[0]](a,b);var e=i.repeat[{day:0,week:1,month:2,year:3}[a[0]]];switch(c[1]){case "no":i.end[0].checked=!0;break;case "":i.end[2].checked=!0;i.date_of_end.value=m(b.end);break;default:i.end[1].checked=!0,i.occurences_count.value=c[1]}e.checked=!0;e.onclick()}c.form_blocks.recurring._ds={start:e.start_date,end:e._end_date};var l=c.date.str_to_date(c.config.repeat_date),k=function(a){var b=l(a);c.config.include_end_by&&
(b=c.date.add(b,1,"day"));return b},m=c.date.date_to_str(c.config.repeat_date),o=a.getElementsByTagName("FORM")[0],i=[];f(o.getElementsByTagName("INPUT"));f(o.getElementsByTagName("SELECT"));if(!c.config.repeat_date_of_end){var t=c.date.date_to_str(c.config.repeat_date);c.config.repeat_date_of_end=t(c.date.add(c._currentDate(),30,"day"))}i.date_of_end.value=c.config.repeat_date_of_end;var n=function(a){return document.getElementById(a)};c.form_blocks.recurring._get_repeat_code=h;var r={month:function(a,
b){g("month_type")=="d"?(a.push(Math.max(1,i.month_count.value)),b.start.setDate(i.month_day.value)):(a.push(Math.max(1,i.month_count2.value)),a.push(i.month_day2.value),a.push(Math.max(1,i.month_week2.value)),b.start.setDate(1));b._start=!0},week:function(a,b){a.push(Math.max(1,i.week_count.value));a.push("");a.push("");for(var e=[],d=i.week_day,f=b.start.getDay(),g=!1,h=0;h<d.length;h++)d[h].checked&&(e.push(d[h].value),g=g||d[h].value==f);e.length||(e.push(f),g=!0);e.sort();if(c.config.repeat_precise){if(!g)c.transpose_day_week(b.start,
e,1,7),b._start=!0}else b.start=c.date.week_start(b.start),b._start=!0;a.push(e.join(","))},day:function(a){g("day_type")=="d"?a.push(Math.max(1,i.day_count.value)):(a.push("week"),a.push(1),a.push(""),a.push(""),a.push("1,2,3,4,5"),a.splice(0,1))},year:function(a,b){g("year_type")=="d"?(a.push("1"),b.start.setMonth(0),b.start.setDate(i.year_day.value),b.start.setMonth(i.year_month.value)):(a.push("1"),a.push(i.year_day2.value),a.push(i.year_week2.value),b.start.setDate(1),b.start.setMonth(i.year_month2.value));
b._start=!0}},s={week:function(a){i.week_count.value=a[1];for(var b=i.week_day,c=a[4].split(","),e={},d=0;d<c.length;d++)e[c[d]]=!0;for(d=0;d<b.length;d++)b[d].checked=!!e[b[d].value]},month:function(a,b){a[2]==""?(i.month_type[0].checked=!0,i.month_count.value=a[1],i.month_day.value=b.start.getDate()):(i.month_type[1].checked=!0,i.month_count2.value=a[1],i.month_week2.value=a[3],i.month_day2.value=a[2])},day:function(a){i.day_type[0].checked=!0;i.day_count.value=a[1]},year:function(a,b){a[2]==""?
(i.year_type[0].checked=!0,i.year_day.value=b.start.getDate(),i.year_month.value=b.start.getMonth()):(i.year_type[1].checked=!0,i.year_week2.value=a[3],i.year_day2.value=a[2],i.year_month2.value=b.start.getMonth())}};c.form_blocks.recurring._set_repeat_code=j;for(var p=0;p<o.elements.length;p++){var q=o.elements[p];switch(q.name){case "repeat":q.onclick=d}}c._lightbox._rec_init_done=!0},set_value:function(a,b,e){var f=c.form_blocks.recurring;c._lightbox._rec_init_done||f._init_set_value(a,b,e);a.open=
!e.rec_type;a.blocked=e.event_pid&&e.event_pid!="0"?!0:!1;var g=f._ds;g.start=e.start_date;g.end=e._end_date;f.button_click(0,a.previousSibling.firstChild.firstChild,a,a);b&&f._set_repeat_code(b,g)},get_value:function(a,b){if(a.open){var e=c.form_blocks.recurring._ds,f={};this.formSection("time").getValue(f);e.start=f.start_date;b.rec_type=c.form_blocks.recurring._get_repeat_code(e);e._start?(b.start_date=new Date(e.start),b._start_date=new Date(e.start),e._start=!1):b._start_date=null;b._end_date=
e.end;b.rec_pattern=b.rec_type.split("#")[0]}else b.rec_type=b.rec_pattern="",b._end_date=b.end_date;return b.rec_type},focus:function(){},button_click:function(a,b,e,f){!f.open&&!f.blocked?(f.style.height="115px",b.style.backgroundPosition="-5px 0px",b.nextSibling.innerHTML=c.locale.labels.button_recurring_open):(f.style.height="0px",b.style.backgroundPosition="-5px 20px",b.nextSibling.innerHTML=c.locale.labels.button_recurring);f.open=!f.open;c.setLightboxSize()}};c._rec_markers={};c._rec_markers_pull=
{};c._add_rec_marker=function(a,b){a._pid_time=b;this._rec_markers[a.id]=a;this._rec_markers_pull[a.event_pid]||(this._rec_markers_pull[a.event_pid]={});this._rec_markers_pull[a.event_pid][b]=a};c._get_rec_marker=function(a,b){var c=this._rec_markers_pull[b];return c?c[a]:null};c._get_rec_markers=function(a){return this._rec_markers_pull[a]||[]};c._rec_temp=[];(function(){var a=c.addEvent;c.addEvent=function(b,e,f,g,d){var h=a.apply(this,arguments);if(h){var j=c.getEvent(h);j.event_pid!=0&&c._add_rec_marker(j,
j.event_length*1E3);if(j.rec_type)j.rec_pattern=j.rec_type.split("#")[0]}return h}})();c.attachEvent("onEventIdChange",function(a,b){if(!this._ignore_call){this._ignore_call=!0;for(var c=0;c<this._rec_temp.length;c++){var f=this._rec_temp[c];if(f.event_pid==a)f.event_pid=b,this.changeEventId(f.id,b+"#"+f.id.split("#")[1])}delete this._ignore_call}});c.attachEvent("onConfirmedBeforeEventDelete",function(a){var b=this.getEvent(a);if(a.toString().indexOf("#")!=-1||b.event_pid&&b.event_pid!="0"&&b.rec_type&&
b.rec_type!="none"){var a=a.split("#"),c=this.uid(),f=a[1]?a[1]:b._pid_time/1E3,g=this._copy_event(b);g.id=c;g.event_pid=b.event_pid||a[0];var d=f;g.event_length=d;g.rec_type=g.rec_pattern="none";this.addEvent(g);this._add_rec_marker(g,d*1E3)}else{b.rec_type&&this._lightbox_id&&this._roll_back_dates(b);var h=this._get_rec_markers(a),j;for(j in h)if(h.hasOwnProperty(j))a=h[j].id,this.getEvent(a)&&this.deleteEvent(a,!0)}return!0});c.attachEvent("onEventChanged",function(a){if(this._loading)return!0;
var b=this.getEvent(a);if(a.toString().indexOf("#")!=-1){var a=a.split("#"),c=this.uid();this._not_render=!0;var f=this._copy_event(b);f.id=c;f.event_pid=a[0];var g=a[1];f.event_length=g;f.rec_type=f.rec_pattern="";this._add_rec_marker(f,g*1E3);this.addEvent(f);this._not_render=!1}else{b.rec_type&&this._lightbox_id&&this._roll_back_dates(b);var d=this._get_rec_markers(a),h;for(h in d)d.hasOwnProperty(h)&&(delete this._rec_markers[d[h].id],this.deleteEvent(d[h].id,!0));delete this._rec_markers_pull[a];
for(var j=!1,l=0;l<this._rendered.length;l++)this._rendered[l].getAttribute("event_id")==a&&(j=!0);if(!j)this._select_id=null}return!0});c.attachEvent("onEventAdded",function(a){if(!this._loading){var b=this.getEvent(a);b.rec_type&&!b.event_length&&this._roll_back_dates(b)}return!0});c.attachEvent("onEventSave",function(a,b){var c=this.getEvent(a);if(!c.rec_type&&b.rec_type&&(a+"").indexOf("#")==-1)this._select_id=null;return!0});c.attachEvent("onEventCreated",function(a){var b=this.getEvent(a);if(!b.rec_type)b.rec_type=
b.rec_pattern=b.event_length=b.event_pid="";return!0});c.attachEvent("onEventCancel",function(a){var b=this.getEvent(a);b.rec_type&&(this._roll_back_dates(b),this.render_view_data())});c._roll_back_dates=function(a){a.event_length=(a.end_date.valueOf()-a.start_date.valueOf())/1E3;a.end_date=a._end_date;a._start_date&&(a.start_date.setMonth(0),a.start_date.setDate(a._start_date.getDate()),a.start_date.setMonth(a._start_date.getMonth()),a.start_date.setFullYear(a._start_date.getFullYear()))};c._validId=
function(a){return a.toString().indexOf("#")==-1};c.showLightbox_rec=c.showLightbox;c.showLightbox=function(a){var b=this.locale,e=c.config.lightbox_recurring,f=this.getEvent(a),g=f.event_pid,d=a.toString().indexOf("#")!=-1;d&&(g=a.split("#")[0]);var h=function(a){var b=c.getEvent(a);b._end_date=b.end_date;b.end_date=new Date(b.start_date.valueOf()+b.event_length*1E3);return c.showLightbox_rec(a)};if((g||g==0)&&f.rec_type)return h(a);if(!g||g==0||!b.labels.confirm_recurring||e=="instance"||e=="series"&&
!d)return this.showLightbox_rec(a);if(e=="ask"){var j=this;dhtmlx.modalbox({text:b.labels.confirm_recurring,title:b.labels.title_confirm_recurring,width:"500px",position:"middle",buttons:[b.labels.button_edit_series,b.labels.button_edit_occurrence,b.labels.icon_cancel],callback:function(b){switch(+b){case 0:return h(g);case 1:return j.showLightbox_rec(a)}}})}else h(g)};c.get_visible_events_rec=c.get_visible_events;c.get_visible_events=function(a){for(var b=0;b<this._rec_temp.length;b++)delete this._events[this._rec_temp[b].id];
this._rec_temp=[];for(var c=this.get_visible_events_rec(a),f=[],b=0;b<c.length;b++)c[b].rec_type?c[b].rec_pattern!="none"&&this.repeat_date(c[b],f):f.push(c[b]);return f};(function(){var a=c.isOneDayEvent;c.isOneDayEvent=function(b){return b.rec_type?!0:a.call(this,b)};var b=c.updateEvent;c.updateEvent=function(a){var f=c.getEvent(a);if(f.rec_type)f.rec_pattern=(f.rec_type||"").split("#")[0];f&&f.rec_type&&a.toString().indexOf("#")===-1?c.update_view():b.call(this,a)}})();c.transponse_size={day:1,
week:7,month:1,year:12};c.date.day_week=function(a,b,c){a.setDate(1);var c=(c-1)*7,f=a.getDay(),g=b*1+c-f+1;a.setDate(g<=c?g+7:g)};c.transpose_day_week=function(a,b,e,f,g){for(var d=(a.getDay()||(c.config.start_on_monday?7:0))-e,h=0;h<b.length;h++)if(b[h]>d)return a.setDate(a.getDate()+b[h]*1-d-(f?e:g));this.transpose_day_week(a,b,e+f,null,e)};c.transpose_type=function(a){var b="transpose_"+a;if(!this.date[b]){var e=a.split("_"),f=864E5,g="add_"+a,d=this.transponse_size[e[0]]*e[1];if(e[0]=="day"||
e[0]=="week"){var h=null;if(e[4]&&(h=e[4].split(","),c.config.start_on_monday)){for(var j=0;j<h.length;j++)h[j]=h[j]*1||7;h.sort()}this.date[b]=function(a,b){var e=Math.floor((b.valueOf()-a.valueOf())/(f*d));e>0&&a.setDate(a.getDate()+e*d);h&&c.transpose_day_week(a,h,1,d)};this.date[g]=function(a,b){var e=new Date(a.valueOf());if(h)for(var f=0;f<b;f++)c.transpose_day_week(e,h,0,d);else e.setDate(e.getDate()+b*d);return e}}else if(e[0]=="month"||e[0]=="year")this.date[b]=function(a,b){var f=Math.ceil((b.getFullYear()*
12+b.getMonth()*1-(a.getFullYear()*12+a.getMonth()*1))/d);f>=0&&a.setMonth(a.getMonth()+f*d);e[3]&&c.date.day_week(a,e[2],e[3])},this.date[g]=function(a,b){var f=new Date(a.valueOf());f.setMonth(f.getMonth()+b*d);e[3]&&c.date.day_week(f,e[2],e[3]);return f}}};c.repeat_date=function(a,b,e,f,g){var f=f||this._min_date,g=g||this._max_date,d=new Date(a.start_date.valueOf());if(!a.rec_pattern&&a.rec_type)a.rec_pattern=a.rec_type.split("#")[0];this.transpose_type(a.rec_pattern);for(c.date["transpose_"+
a.rec_pattern](d,f);d<a.start_date||c._fix_daylight_saving_date(d,f,a,d,new Date(d.valueOf()+a.event_length*1E3)).valueOf()<=f.valueOf()||d.valueOf()+a.event_length*1E3<=f.valueOf();)d=this.date.add(d,1,a.rec_pattern);for(;d<g&&d<a.end_date;){var h=c.config.occurrence_timestamp_in_utc?Date.UTC(d.getFullYear(),d.getMonth(),d.getDate(),d.getHours(),d.getMinutes(),d.getSeconds()):d.valueOf(),j=this._get_rec_marker(h,a.id);if(j)e&&b.push(j);else{var l=new Date(d.valueOf()+a.event_length*1E3),k=this._copy_event(a);
k.text=a.text;k.start_date=d;k.event_pid=a.id;k.id=a.id+"#"+Math.ceil(h/1E3);k.end_date=l;k.end_date=c._fix_daylight_saving_date(k.start_date,k.end_date,a,d,k.end_date);k._timed=this.isOneDayEvent(k);if(!k._timed&&!this._table_view&&!this.config.multi_day)break;b.push(k);e||(this._events[k.id]=k,this._rec_temp.push(k))}d=this.date.add(d,1,a.rec_pattern)}};c._fix_daylight_saving_date=function(a,b,c,f,g){var d=a.getTimezoneOffset()-b.getTimezoneOffset();return d?d>0?new Date(f.valueOf()+c.event_length*
1E3-d*6E4):new Date(b.valueOf()-d*6E4):new Date(g.valueOf())};c.getRecDates=function(a,b){var e=typeof a=="object"?a:c.getEvent(a),f=0,g=[],b=b||100,d=new Date(e.start_date.valueOf()),h=new Date(d.valueOf());if(!e.rec_type)return[{start_date:e.start_date,end_date:e.end_date}];if(e.rec_type=="none")return[];this.transpose_type(e.rec_pattern);for(c.date["transpose_"+e.rec_pattern](d,h);d<e.start_date||d.valueOf()+e.event_length*1E3<=h.valueOf();)d=this.date.add(d,1,e.rec_pattern);for(;d<e.end_date;){var j=
this._get_rec_marker(d.valueOf(),e.id),l=!0;if(j)j.rec_type=="none"?l=!1:g.push({start_date:j.start_date,end_date:j.end_date});else{var k=new Date(d),m=new Date(d.valueOf()+e.event_length*1E3),m=c._fix_daylight_saving_date(k,m,e,d,m);g.push({start_date:k,end_date:m})}d=this.date.add(d,1,e.rec_pattern);if(l&&(f++,f==b))break}return g};c.getEvents=function(a,b){var c=[],f;for(f in this._events){var g=this._events[f];if(g&&g.start_date<b&&g.end_date>a)if(g.rec_pattern){if(g.rec_pattern!="none"){var d=
[];this.repeat_date(g,d,!0,a,b);for(var h=0;h<d.length;h++)!d[h].rec_pattern&&d[h].start_date<b&&d[h].end_date>a&&!this._rec_markers[d[h].id]&&c.push(d[h])}}else g.id.toString().indexOf("#")==-1&&c.push(g)}return c};c.config.repeat_date="%m.%d.%Y";c.config.lightbox.sections=[{name:"description",height:130,map_to:"text",type:"textarea",focus:!0},{name:"recurring",type:"recurring",map_to:"rec_type",button:"recurring"},{name:"time",height:72,type:"time",map_to:"auto"}];c._copy_dummy=function(){var a=
new Date(this.start_date),b=new Date(this.end_date);this.start_date=a;this.end_date=b;this.event_length=this.event_pid=this.rec_pattern=this.rec_type=null};c.config.include_end_by=!1;c.config.lightbox_recurring="ask";c.attachEvent("onClearAll",function(){c._rec_markers={};c._rec_markers_pull={};c._rec_temp=[]});c.__recurring_template='<div class="dhx_form_repeat"> <form> <div class="dhx_repeat_left"> <label><input class="dhx_repeat_radio" type="radio" name="repeat" value="day" />Daily</label><br /> <label><input class="dhx_repeat_radio" type="radio" name="repeat" value="week"/>Weekly</label><br /> <label><input class="dhx_repeat_radio" type="radio" name="repeat" value="month" checked />Monthly</label><br /> <label><input class="dhx_repeat_radio" type="radio" name="repeat" value="year" />Yearly</label> </div> <div class="dhx_repeat_divider"></div> <div class="dhx_repeat_center"> <div style="display:none;" id="dhx_repeat_day"> <label><input class="dhx_repeat_radio" type="radio" name="day_type" value="d"/>Every</label><input class="dhx_repeat_text" type="text" name="day_count" value="1" />day<br /> <label><input class="dhx_repeat_radio" type="radio" name="day_type" checked value="w"/>Every workday</label> </div> <div style="display:none;" id="dhx_repeat_week"> Repeat every<input class="dhx_repeat_text" type="text" name="week_count" value="1" />week next days:<br /> <table class="dhx_repeat_days"> <tr> <td> <label><input class="dhx_repeat_checkbox" type="checkbox" name="week_day" value="1" />Monday</label><br /> <label><input class="dhx_repeat_checkbox" type="checkbox" name="week_day" value="4" />Thursday</label> </td> <td> <label><input class="dhx_repeat_checkbox" type="checkbox" name="week_day" value="2" />Tuesday</label><br /> <label><input class="dhx_repeat_checkbox" type="checkbox" name="week_day" value="5" />Friday</label> </td> <td> <label><input class="dhx_repeat_checkbox" type="checkbox" name="week_day" value="3" />Wednesday</label><br /> <label><input class="dhx_repeat_checkbox" type="checkbox" name="week_day" value="6" />Saturday</label> </td> <td> <label><input class="dhx_repeat_checkbox" type="checkbox" name="week_day" value="0" />Sunday</label><br /><br /> </td> </tr> </table> </div> <div id="dhx_repeat_month"> <label><input class="dhx_repeat_radio" type="radio" name="month_type" value="d"/>Repeat</label><input class="dhx_repeat_text" type="text" name="month_day" value="1" />day every<input class="dhx_repeat_text" type="text" name="month_count" value="1" />month<br /> <label><input class="dhx_repeat_radio" type="radio" name="month_type" checked value="w"/>On</label><input class="dhx_repeat_text" type="text" name="month_week2" value="1" /><select name="month_day2"><option value="1" selected >Monday<option value="2">Tuesday<option value="3">Wednesday<option value="4">Thursday<option value="5">Friday<option value="6">Saturday<option value="0">Sunday</select>every<input class="dhx_repeat_text" type="text" name="month_count2" value="1" />month<br /> </div> <div style="display:none;" id="dhx_repeat_year"> <label><input class="dhx_repeat_radio" type="radio" name="year_type" value="d"/>Every</label><input class="dhx_repeat_text" type="text" name="year_day" value="1" />day<select name="year_month"><option value="0" selected >January<option value="1">February<option value="2">March<option value="3">April<option value="4">May<option value="5">June<option value="6">July<option value="7">August<option value="8">September<option value="9">October<option value="10">November<option value="11">December</select>month<br /> <label><input class="dhx_repeat_radio" type="radio" name="year_type" checked value="w"/>On</label><input class="dhx_repeat_text" type="text" name="year_week2" value="1" /><select name="year_day2"><option value="1" selected >Monday<option value="2">Tuesday<option value="3">Wednesday<option value="4">Thursday<option value="5">Friday<option value="6">Saturday<option value="7">Sunday</select>of<select name="year_month2"><option value="0" selected >January<option value="1">February<option value="2">March<option value="3">April<option value="4">May<option value="5">June<option value="6">July<option value="7">August<option value="8">September<option value="9">October<option value="10">November<option value="11">December</select><br /> </div> </div> <div class="dhx_repeat_divider"></div> <div class="dhx_repeat_right"> <label><input class="dhx_repeat_radio" type="radio" name="end" checked/>No end date</label><br /> <label><input class="dhx_repeat_radio" type="radio" name="end" />After</label><input class="dhx_repeat_text" type="text" name="occurences_count" value="1" />occurrences<br /> <label><input class="dhx_repeat_radio" type="radio" name="end" />End by</label><input class="dhx_repeat_date" type="text" name="date_of_end" value="'+
c.config.repeat_date_of_end+'" /><br /> </div> </form> </div> <div style="clear:both"> </div>'});
